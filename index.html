<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>üéâ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');
    
    * { margin:0; padding:0; box-sizing:border-box; -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; }
    html, body { width:100%; height:100%; overflow:hidden; background:#000; font-family: 'Poppins', ui-sans-serif, system-ui, -apple-system, sans-serif; }
    body { position:fixed; inset:0; }
    #canvas { width:100vw; height:100vh; display:block; touch-action:none; cursor:crosshair; }

    .welcome { 
      position:absolute; inset:0; display:grid; place-items:center; padding:24px; 
      background: radial-gradient(ellipse at 50% 40%, rgba(255,105,180,.15), transparent 70%),
                  radial-gradient(ellipse at 20% 80%, rgba(106,108,255,.12), transparent 60%),
                  radial-gradient(ellipse at 80% 20%, rgba(255,200,113,.1), transparent 50%),
                  linear-gradient(135deg, #1a0b2e 0%, #2d1b3d 50%, #1f0e2e 100%);
      z-index:50; transition:opacity .8s cubic-bezier(0.4, 0, 0.2, 1); 
    }
    .welcome.hidden { opacity:0; pointer-events:none; }
    .welcome__card { 
      width:min(540px,90vw); color:white; text-align:center; padding:48px 32px; 
      border-radius:32px; 
      background: linear-gradient(145deg, rgba(255,255,255,.08) 0%, rgba(255,255,255,.03) 100%);
      backdrop-filter:blur(24px); 
      box-shadow: 0 8px 32px rgba(0,0,0,.4),
                  inset 0 1px 0 rgba(255,255,255,.1),
                  0 24px 64px rgba(255,105,180,.2);
      border: 1px solid rgba(255,255,255,.1);
    }
    .welcome__title { 
      font-size:clamp(32px,5.5vw,52px); font-weight:800; letter-spacing:-.5px; 
      margin-bottom:16px; 
      background: linear-gradient(135deg, #ff69b4 0%, #ffd36a 50%, #6a6cff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation:shimmer 3s ease-in-out infinite;
    }
    @keyframes shimmer {
      0%, 100% { filter: brightness(1) saturate(1); }
      50% { filter: brightness(1.2) saturate(1.3); }
    }
    .welcome__txt { 
      font-size:clamp(15px,3vw,18px); line-height:1.8; opacity:.9; 
      font-weight:400; margin-bottom:8px;
    }
    .welcome__btn { 
      margin-top:28px; border:0; border-radius:999px; padding:18px 42px; 
      font-size:clamp(16px,3.5vw,19px); font-weight:700; color:#fff; 
      background: linear-gradient(135deg, #ff69b4 0%, #ff5f9e 100%);
      cursor:pointer; 
      box-shadow: 0 12px 28px rgba(255,105,180,.4),
                  0 4px 12px rgba(0,0,0,.3),
                  inset 0 1px 0 rgba(255,255,255,.3);
      transition: all .3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Poppins', sans-serif;
      letter-spacing: .3px;
    }
    .welcome__btn:hover { 
      transform:translateY(-2px); 
      box-shadow: 0 16px 36px rgba(255,105,180,.5),
                  0 6px 16px rgba(0,0,0,.4);
    }
    .welcome__btn:active { 
      transform:translateY(0px); 
      box-shadow: 0 8px 20px rgba(255,105,180,.4);
    }

    .hud { 
      position:absolute; top:24px; left:50%; transform:translateX(-50%); 
      color:#fff; padding:14px 28px; border-radius:999px; 
      background: linear-gradient(135deg, rgba(0,0,0,.6), rgba(0,0,0,.4));
      backdrop-filter:blur(16px); text-align:center; z-index:10; pointer-events:none; 
      box-shadow: 0 8px 24px rgba(0,0,0,.3),
                  inset 0 1px 0 rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.08);
    }
    .hud h2 { 
      font-size:clamp(14px,2.8vw,17px); font-weight:600; letter-spacing:.4px; 
      background: linear-gradient(135deg, #fff 0%, #ffd36a 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .toast { 
      position:absolute; top:84px; left:50%; transform:translateX(-50%); 
      color:#fff; padding:12px 24px; border-radius:999px; 
      background: linear-gradient(135deg, rgba(106,108,255,.6), rgba(255,105,180,.5));
      backdrop-filter:blur(12px);
      font-size:clamp(11px,2.2vw,13px); z-index:10; pointer-events:none; 
      animation:floatPulse 4s ease-in-out infinite;
      box-shadow: 0 4px 16px rgba(106,108,255,.3);
      border: 1px solid rgba(255,255,255,.15);
      font-weight:500;
    }
    @keyframes floatPulse { 
      0%,100%{opacity:.7; transform:translateX(-50%) translateY(0px)} 
      50%{opacity:1; transform:translateX(-50%) translateY(-4px)} 
    }

    .controls-desktop, .controls-mobile { position:absolute; z-index:12; }
    .controls-desktop { 
      bottom:24px; left:24px; color:#fff; 
      background: linear-gradient(135deg, rgba(0,0,0,.7), rgba(0,0,0,.5));
      backdrop-filter:blur(16px);
      padding:16px 20px; border-radius:20px; 
      font-size:13px; line-height:1.9; font-weight:500;
      box-shadow: 0 8px 24px rgba(0,0,0,.4),
                  inset 0 1px 0 rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.1);
    }
    .kbd{ 
      background: linear-gradient(145deg, #4a4a5e, #363647);
      padding:4px 10px; border-radius:8px; font-weight:700; 
      box-shadow: 0 2px 6px rgba(0,0,0,.3),
                  inset 0 1px 0 rgba(255,255,255,.15);
      border: 1px solid rgba(255,255,255,.1);
      font-size:12px;
      color:#fff;
    }

    .controls-mobile { bottom:24px; left:0; right:0; display:none; justify-content:space-between; align-items:flex-end; padding:0 20px; }
    .controls-mobile.active { display:flex; }
    .joy { position:relative; width:130px; height:130px; touch-action:none; }
    .joy__base { 
      position:absolute; inset:0; border-radius:50%; 
      background: linear-gradient(145deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      backdrop-filter:blur(12px);
      border:3px solid rgba(255,255,255,.2); 
      box-shadow: 0 8px 24px rgba(0,0,0,.4),
                  inset 0 2px 8px rgba(255,255,255,.1);
    }
    .joy__stick { 
      position:absolute; width:60px; height:60px; left:35px; top:35px; 
      border-radius:50%; 
      background: linear-gradient(145deg, rgba(255,255,255,.95), rgba(240,240,255,.9));
      border:3px solid rgba(255,105,180,.5); 
      transition:transform .08s cubic-bezier(0.4, 0, 0.2, 1); 
      box-shadow: 0 6px 20px rgba(255,105,180,.4),
                  0 2px 8px rgba(0,0,0,.3);
    }

    .actions { display:flex; flex-direction:column; gap:14px; }
    .btn { 
      min-width:120px; border:0; border-radius:18px; padding:16px 22px; 
      font-size:15px; font-weight:700; color:white; 
      background: linear-gradient(135deg,#6a6cff,#9b5eff); 
      box-shadow: 0 6px 20px rgba(106,108,255,.4),
                  inset 0 1px 0 rgba(255,255,255,.2);
      touch-action:manipulation;
      font-family: 'Poppins', sans-serif;
      transition: all .2s ease;
      border: 1px solid rgba(255,255,255,.15);
    }
    .btn:active { transform:scale(.96); box-shadow: 0 4px 12px rgba(106,108,255,.3); }
    .btn--primary { 
      background: linear-gradient(135deg,#ff69b4,#ff5f9e); 
      font-size:17px; padding:18px 24px;
      box-shadow: 0 8px 24px rgba(255,105,180,.4),
                  inset 0 1px 0 rgba(255,255,255,.2);
    }
    .btn--ghost { 
      background: linear-gradient(135deg,#ffd36a,#ffb347);
      box-shadow: 0 6px 20px rgba(255,179,71,.4),
                  inset 0 1px 0 rgba(255,255,255,.2);
    }

    .fab { position:absolute; top:24px; right:24px; z-index:12; display:flex; gap:12px; }
    .fab button { 
      width:52px; height:52px; border-radius:50%; border:0; 
      background: linear-gradient(135deg, rgba(0,0,0,.7), rgba(0,0,0,.5));
      backdrop-filter:blur(16px);
      color:#fff; font-size:22px; 
      box-shadow: 0 6px 20px rgba(0,0,0,.4),
                  inset 0 1px 0 rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.1);
      transition: all .2s ease;
      cursor:pointer;
    }
    .fab button:hover { transform:scale(1.05); }
    .fab button:active { transform:scale(.95); }

    .modal { position:absolute; inset:0; display:none; place-items:center; z-index:60; }
    .modal.active { display:grid; }
    .modal__bg { 
      position:absolute; inset:0; 
      background:rgba(0,0,0,.75); 
      backdrop-filter:blur(8px); 
    }
    .modal__card { 
      position:relative; width:min(580px,90vw); max-height:85vh; overflow:auto; 
      background: linear-gradient(145deg, #ffffff, #f5f5f5);
      border-radius:32px; padding:40px 32px; 
      box-shadow: 0 24px 80px rgba(0,0,0,.6),
                  0 8px 32px rgba(0,0,0,.4);
      animation:modalIn .4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes modalIn { 
      from{transform:scale(.85) translateY(20px); opacity:0} 
      to{transform:scale(1) translateY(0); opacity:1} 
    }
    .modal h2 { 
      background: linear-gradient(135deg, #ff69b4 0%, #6a6cff 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size:clamp(24px,4.5vw,32px); margin:0 0 20px 0; text-align:center; 
      font-weight:800; letter-spacing:-.5px;
    }
    .modal p { 
      color:#333; line-height:1.9; margin:14px 0; 
      font-size:clamp(15px,3.2vw,17px); font-weight:400;
    }
    .modal__row { display:flex; flex-wrap:wrap; gap:12px; justify-content:center; margin-top:24px; }
    .modal .btn { 
      color:#555; 
      background: linear-gradient(145deg, #f0f0f0, #e0e0e0);
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
    }
    .modal .btn--primary { 
      color:white; 
      background: linear-gradient(135deg,#6a6cff,#9b5eff);
      box-shadow: 0 6px 20px rgba(106,108,255,.4);
    }

    .tip { position:absolute; inset:0; display:none; place-items:center; z-index:9; }
    .tip.active { display:grid; }
    .tip__card { 
      color:#fff; 
      background: linear-gradient(135deg, rgba(0,0,0,.85), rgba(0,0,0,.7));
      backdrop-filter:blur(16px);
      padding:20px 32px; border-radius:20px; text-align:center; font-weight:500;
      box-shadow: 0 8px 24px rgba(0,0,0,.5),
                  inset 0 1px 0 rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.1);
    }

    .sr-only { position:absolute; left:-9999px; }

    /* Custom scrollbar for modal */
    .modal__card::-webkit-scrollbar { width: 8px; }
    .modal__card::-webkit-scrollbar-track { background: rgba(0,0,0,.05); border-radius: 10px; }
    .modal__card::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #ff69b4, #6a6cff); border-radius: 10px; }
  </style>
</head>
<body>
  <section class="welcome" id="welcome">
  <div class="welcome__card">
    <h1 class="welcome__title">üéâ Happy Birthday! üéâ</h1>
    <p class="welcome__txt">Ch·ªã l√†m cho B·∫£o Phong n√®ee!</p>
    <button class="welcome__btn" id="startBtn">B·∫•m d√¥√¥√¥√¥√¥</button>
  </div>
  </section>

  <div class="toast" id="toast"></div>
  <div class="tip" id="lockTip"><div class="tip__card"></div></div>
  <canvas id="canvas" tabindex="0" aria-label="T·∫∑ng Phong n√®ee"></canvas>

  <div class="hud"><h2>üéÇ ƒêi v√≤ng v√≤ng xem ƒëi</h2></div>

  <div class="fab">
    <button id="musicBtn" title="Toggle Music">üîä</button>
    <button id="resetBtn" title="Reset Position">‚ü≥</button>
  </div>

  <aside class="controls-desktop" id="helpDesktop">
    <div><span class="kbd">W</span><span class="kbd">A</span><span class="kbd">S</span><span class="kbd">D</span> Move around</div>
    <div><span class="kbd">Space</span> Jump ‚Ä¢ <span class="kbd">E</span> Interact with objects</div>
    <div><span class="kbd">L</span> Toggle lights ‚Ä¢ <span class="kbd">B</span> Blow candles ‚Ä¢ <b>Click to look</b></div>
  </aside>

  <aside class="controls-mobile" id="controlsMobile">
    <div class="joy" id="joy">
      <div class="joy__base"></div>
      <div class="joy__stick" id="joyStick"></div>
    </div>
    <div class="actions">
      <button class="btn btn--primary" id="btnJump">üöÄNh·∫£y</button>
      <button class="btn btn--ghost" id="btnBlow">üí®Th·ªïi n·∫øn</button>
      <button class="btn" id="btnLights">üí°ƒê√®n</button>
    </div>
  </aside>


  <section class="modal" id="wishModal" role="dialog" aria-modal="true" aria-labelledby="wishTitle">
    <div class="modal__bg" data-close></div>
    <div class="modal__card">
      <h2 id="wishTitle">üíù Th√¢n G·ª≠i B·∫£o Phong üíù</h2>
      <p>Ch√∫c m·ª´ng sinh nh·∫≠t, b√© iu c·ªßa ch·ªã! D√π t·ª•i m√¨nh xa nhau, ch·ªã v·∫´n lu√¥n ·ªü g·∫ßn tr√°i tim c·ªßa Phong. C·∫£m ∆°n em ƒë√£ mang ƒë·∫øn cho cu·ªôc s·ªëng c·ªßa ch·ªã th·∫≠t nhi·ªÅu s·∫Øc m√†u, ·∫•m √°p v√† ni·ªÅm vui.</p>
      <p>NƒÉm 20t n√†y, ch·ªã ch√∫c Phong nh·ªØng kho·∫£nh kh·∫Øc h·∫°nh ph√∫c, nh·ªØng ƒëi·ªÅu th√∫ v·ªã b·∫•t ng·ªù v√† nh·ªØng th√†nh c√¥ng vi√™n m√£n. Mong r·∫±ng m·ªçi ∆∞·ªõc m∆° c·ªßa em s·∫Ω ƒë·∫øn g·∫ßn em h∆°n m·ªói ng√†y. üåü</p>
      <p>Ch·ªã r·∫•t mong ch·ªù ng√†y t·ª•i ƒë∆∞·ª£c c√πng nhau ƒÉn m·ª´ng sinh nh·∫≠t ti·∫øp theo. Cho ƒë·∫øn khi kho·∫£nh kh·∫Øc ƒë√≥ t·ªõi, ch·ªã xin g·ª≠i ƒë·∫øn Phong t·∫•t c·∫£ t√¨nh y√™u c·ªßa ch·ªã t·ª´ ph∆∞∆°ng xa. ‚ù§Ô∏è</p>
      <p><b>Happy Birthday, B·∫£o Phong iu d·∫•uuuu üéÇüéâ</b></p>
      <div class="modal__row">
        <button class="btn" data-close>Close</button>
        <button class="btn btn--primary" id="btnPlayVoice">‚ñ∂ Nghe gi·ªçng ch·ªã n√®ee </button>
      </div>
      <audio id="voicePlayer" class="sr-only"></audio>
    </div>
  </section>

  <script>
  // ====== CORE STATE ======
  let scene, camera, renderer, clock;
  let velocity = new THREE.Vector3();
  let direction = new THREE.Vector3();
  let canJump = true;
  let isDesktop = window.innerWidth > 820 && !/Mobi|Android/i.test(navigator.userAgent);

  const euler = new THREE.Euler(0,0,0,'YXZ');
  const PI_2 = Math.PI/2;

  const roomLights = [];
  const candles = [];
  let fairyLights = [];
  let lightsOn = true;

  const interactiveMeshes = [];
  let tvRef = null;
  const INTERACT_RAY_MAX = 8;

  let audioCtx, loopTimer = null, musicOn = true;

  let joyActive=false, joyVec={x:0,y:0};
  let lookTouchId=null, lastTouchX=0, lastTouchY=0;

  const EYE_HEIGHT = 1.6;
  const ROOM_BOUND = 11.2;

  const colliders = [];
  const windowMeshes = [];

  const moves = { forward: false, backward: false, left: false, right: false };

  let cakeGroup = null;
  let confettiParticles = null;
  let balloons = [];
  let candlesLit = true;

  const notes = [
    {freq: 261.63, dur: 0.3}, // C4
    {freq: 261.63, dur: 0.3},
    {freq: 293.66, dur: 0.6}, // D4
    {freq: 261.63, dur: 0.6},
    {freq: 349.23, dur: 0.6}, // F4
    {freq: 329.63, dur: 0.6}, // E4
    {freq: 261.63, dur: 0.3},
    {freq: 261.63, dur: 0.3},
    {freq: 293.66, dur: 0.6},
    {freq: 261.63, dur: 0.6},
    {freq: 392.00, dur: 0.6}, // G4
    {freq: 349.23, dur: 0.6},
    {freq: 261.63, dur: 0.3},
    {freq: 261.63, dur: 0.3},
    {freq: 523.25, dur: 0.6}, // C5
    {freq: 440.00, dur: 0.6}, // A4
    {freq: 349.23, dur: 0.6},
    {freq: 329.63, dur: 0.6},
    {freq: 293.66, dur: 0.6},
    {freq: 466.16, dur: 0.3}, // Bb4
    {freq: 466.16, dur: 0.3},
    {freq: 440.00, dur: 0.6},
    {freq: 349.23, dur: 0.6},
    {freq: 392.00, dur: 0.6},
    {freq: 349.23, dur: 0.6}
  ];

  // ====== STARTUP ======
  const canvas = document.getElementById('canvas');
  const welcome = document.getElementById('welcome');
  document.getElementById('startBtn').addEventListener('click', startExperience);

  function startExperience(){
    welcome.classList.add('hidden');
    init3D();
    initUI();
    canvas.focus({preventScroll:true});
    if(isDesktop){ document.getElementById('lockTip').classList.add('active'); }
    startMusic();
    animate();
  }

  function init3D(){
    clock = new THREE.Clock();
    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0x1a0b2e, 8, 28);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.set(0, EYE_HEIGHT, 8);

    renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:false});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.2;

    setupLights();
    buildRoom();
    buildFurnitures();
    buildLivingSet();
    buildCloset();
    buildCake();
    buildBanner();
    buildPhotoFrame();
    buildStringLights();
    addDecorations();

    window.addEventListener('resize', onResize);
  }

  function setupLights(){
    const amb = new THREE.AmbientLight(0xffeedd, .4); 
    amb.userData.intensity = 0.4;
    scene.add(amb); 
    roomLights.push(amb);
    
    const dir = new THREE.DirectionalLight(0xfff5e6, 1.0); 
    dir.position.set(3, 12, 6); 
    dir.castShadow = true; 
    dir.shadow.mapSize.set(2048,2048); 
    dir.shadow.camera.left = -15;
    dir.shadow.camera.right = 15;
    dir.shadow.camera.top = 15;
    dir.shadow.camera.bottom = -15;
    dir.userData.intensity = 1.0;
    scene.add(dir); 
    roomLights.push(dir);
    
    const p1 = new THREE.PointLight(0xffd9a8, 1.5, 18); 
    p1.position.set(-5,7,-4); 
    p1.castShadow = true; 
    p1.userData.intensity = 1.5;
    scene.add(p1); 
    roomLights.push(p1);
    
    const p2 = new THREE.PointLight(0xffd9a8, 1.5, 18); 
    p2.position.set(5,7,-4); 
    p2.castShadow = true; 
    p2.userData.intensity = 1.5;
    scene.add(p2); 
    roomLights.push(p2);
    
    const warm = new THREE.PointLight(0xffbb77, 1.2, 8); 
    warm.position.set(0,2.2,0); 
    warm.userData.intensity = 1.2;
    scene.add(warm); 
    roomLights.push(warm);
  }

  function buildRoom(){
    // Realistic wood floor with texture simulation
    const floorGeo = new THREE.PlaneGeometry(25,25,50,50);
    const floorMat = new THREE.MeshStandardMaterial({ 
      color:0x5a3825, 
      roughness:.75, 
      metalness:.05,
    });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI/2; 
    floor.receiveShadow = true; 
    scene.add(floor);

    // Add wood planks
    for(let i=-12; i<12; i+=1.2){
      const plank = new THREE.Mesh(
        new THREE.PlaneGeometry(1.15, 25), 
        new THREE.MeshStandardMaterial({ 
          color: i%2 ? 0x4a2f1f : 0x5a3825, 
          roughness:.8, 
          metalness:.02
        })
      );
      plank.rotation.x = -Math.PI/2;
      plank.position.set(i, .002, 0);
      plank.receiveShadow = true;
      scene.add(plank);
    }

    // Walls with realistic colors
    const wallMat = new THREE.MeshStandardMaterial({ 
      color:0xf5e6d3, 
      roughness:.92,
      metalness:.02
    });
    
    const back = new THREE.Mesh(new THREE.PlaneGeometry(25,10), wallMat); 
    back.position.set(0,5,-12.5); 
    back.receiveShadow = true; 
    scene.add(back);
    
    const left = new THREE.Mesh(new THREE.PlaneGeometry(25,10), wallMat.clone()); 
    left.position.set(-12.5,5,0); 
    left.rotation.y = Math.PI/2; 
    left.receiveShadow = true;
    scene.add(left);
    
    const right = new THREE.Mesh(new THREE.PlaneGeometry(25,10), wallMat.clone()); 
    right.position.set(12.5,5,0); 
    right.rotation.y = -Math.PI/2; 
    right.receiveShadow = true;
    scene.add(right);
    
    // Ceiling
    const ceiling = new THREE.Mesh(
      new THREE.PlaneGeometry(25,25), 
      new THREE.MeshStandardMaterial({ color:0xffffff, roughness:.95 })
    );
    ceiling.position.y = 10; 
    ceiling.rotation.x = Math.PI/2; 
    ceiling.receiveShadow = true;
    scene.add(ceiling);

    // Beautiful windows with frames
    [-6,6].forEach(x=>{
      // Window frame
      const frame = new THREE.Mesh(
        new THREE.BoxGeometry(5.3,6.3,.15),
        new THREE.MeshStandardMaterial({ color:0x8b7355, roughness:.6, metalness:.1 })
      );
      frame.position.set(x,4,-12.42);
      frame.castShadow = true;
      scene.add(frame);

      // Window glass with realistic glow
      const winMat = new THREE.MeshStandardMaterial({ 
        color:0xb3d9ff, 
        emissive:0x87ceeb, 
        emissiveIntensity:.8, 
        transparent:true, 
        opacity:.6,
        roughness:.1,
        metalness:.1
      });
      const w = new THREE.Mesh(new THREE.PlaneGeometry(4.8,5.8), winMat);
      w.position.set(x,4,-12.38);
      scene.add(w);
      windowMeshes.push(w);
    });

    // Baseboard
    const baseboard = new THREE.Mesh(
      new THREE.BoxGeometry(25, .3, .2),
      new THREE.MeshStandardMaterial({ color:0x3d2817, roughness:.7 })
    );
    baseboard.position.set(0, .15, -12.4);
    baseboard.castShadow = true;
    scene.add(baseboard);
  }

  function addBoxCollider(cx, topY, cz, sizeX, sizeZ){
    const halfX=sizeX/2, halfZ=sizeZ/2;
    colliders.push({ minX:cx-halfX, maxX:cx+halfX, minZ:cz-halfZ, maxZ:cz+halfZ, topY });
  }

  function buildFurnitures(){
    // Realistic bed
    const bedWood = new THREE.MeshStandardMaterial({ color:0x6b4423, roughness:.65, metalness:.15 });
    const frame = new THREE.Mesh(new THREE.BoxGeometry(5.2,.5,6.2), bedWood); 
    frame.position.set(-7,.25,-8); 
    frame.castShadow=true; 
    frame.receiveShadow=true; 
    scene.add(frame);
    
    const mattress = new THREE.Mesh(
      new THREE.BoxGeometry(4.9,.75,5.9), 
      new THREE.MeshStandardMaterial({ color:0xfaf9f6, roughness:.85, metalness:.02 })
    ); 
    mattress.position.set(-7,0.85,-8); 
    mattress.castShadow=true; 
    scene.add(mattress);
    
    // Pillows
    [-1.6,-.5,.6,1.7].forEach((dx,i)=>{ 
      const p=new THREE.Mesh(
        new THREE.BoxGeometry(1.2,.35,.85), 
        new THREE.MeshStandardMaterial({ color: i%2 ? 0xffeedd : 0xffd9b3, roughness:.9 })
      ); 
      p.position.set(-7+dx,1.35,-9.8); 
      p.rotation.x=-.25; 
      p.castShadow=true; 
      scene.add(p); 
    });
    
    // Beautiful blanket
    const blanket = new THREE.Mesh(
      new THREE.BoxGeometry(4.5,.18,4.2), 
      new THREE.MeshStandardMaterial({ 
        color:0xff91b5,
        roughness:.7,
        metalness:.05
      })
    ); 
    blanket.position.set(-7,1.2,-7.2); 
    blanket.castShadow=true; 
    scene.add(blanket);
    addBoxCollider(-7,1.2,-8,4.9,5.9);

    // Beautiful dining table
    const tableWood = new THREE.MeshStandardMaterial({ color:0x7d5a3a, roughness:.55, metalness:.2 });
    const table = new THREE.Mesh(new THREE.BoxGeometry(5.2,.25,4.2), tableWood); 
    table.position.set(0,1.3,0); 
    table.castShadow=true; 
    table.receiveShadow=true; 
    scene.add(table);
    
    // Table legs with details
    [[-2.4,-1.9],[2.4,-1.9],[-2.4,1.9],[2.4,1.9]].forEach(([x,z])=>{ 
      const leg=new THREE.Mesh(
        new THREE.CylinderGeometry(.14,.16,1.3,16), 
        new THREE.MeshStandardMaterial({ color:0x6b4423, roughness:.6, metalness:.15 })
      ); 
      leg.position.set(x,.65,z); 
      leg.castShadow=true; 
      scene.add(leg); 
    });
    
    // Elegant table cloth
    const cloth = new THREE.Mesh(
      new THREE.BoxGeometry(5.5,.04,4.5), 
      new THREE.MeshStandardMaterial({ 
        color:0xffeaa7, 
        roughness:.65, 
        metalness:.3,
        emissive:0xffd93d,
        emissiveIntensity:.15
      })
    ); 
    cloth.position.set(0,1.42,0); 
    cloth.castShadow=true; 
    scene.add(cloth);
    addBoxCollider(0,1.42,0,5.4,4.4);

    // Luxurious rug
    const rug = new THREE.Mesh(
      new THREE.PlaneGeometry(8.5,7.5), 
      new THREE.MeshStandardMaterial({ 
        color:0xa41623, 
        roughness:.95,
        metalness:.05
      })
    ); 
    rug.rotation.x=-Math.PI/2; 
    rug.position.set(0,.015,0); 
    rug.receiveShadow=true; 
    scene.add(rug);

    // Rug decorative border
    const rugBorder = new THREE.Mesh(
      new THREE.PlaneGeometry(8.7,7.7), 
      new THREE.MeshStandardMaterial({ 
        color:0xffda79, 
        roughness:.9
      })
    ); 
    rugBorder.rotation.x=-Math.PI/2; 
    rugBorder.position.set(0,.012,0); 
    rugBorder.receiveShadow=true; 
    scene.add(rugBorder);
  }

  function buildLivingSet(){
    // Modern sofa materials
    const sofaFabric = new THREE.MeshStandardMaterial({ 
      color:0x4a4d6a, 
      roughness:.8,
      metalness:.05
    });
    const cushionMat = new THREE.MeshStandardMaterial({ 
      color:0x5d6082, 
      roughness:.85
    });

    // Sofa base
    const sofaBase = new THREE.Mesh(new THREE.BoxGeometry(3.8,.55,1.3), sofaFabric); 
    sofaBase.position.set(7.5,.27,2.2); 
    sofaBase.castShadow=true; 
    sofaBase.receiveShadow=true; 
    scene.add(sofaBase);
    
    // Sofa back
    const sofaBack = new THREE.Mesh(new THREE.BoxGeometry(3.8,1.1,.25), sofaFabric); 
    sofaBack.position.set(7.5,1.0,1.5); 
    sofaBack.castShadow=true;
    scene.add(sofaBack);
    
    // Sofa cushions
    for(let i=0;i<3;i++){ 
      const c=new THREE.Mesh(new THREE.BoxGeometry(1.15,.4,.95), cushionMat); 
      c.position.set(6.15+i*1.2,0.75,2.2); 
      c.castShadow=true; 
      scene.add(c); 
    }
    
    // Decorative pillows
    [-1.2,1.2].forEach(offset=>{
      const pillow = new THREE.Mesh(
        new THREE.BoxGeometry(.6,.5,.4),
        new THREE.MeshStandardMaterial({ color:0xff91b5, roughness:.75 })
      );
      pillow.position.set(7.5+offset, 0.9, 1.7);
      pillow.rotation.z = offset > 0 ? 0.2 : -0.2;
      pillow.castShadow = true;
      scene.add(pillow);
    });
    
    addBoxCollider(7.5,0.75,2.2,3.8,1.3);

    // Chaise lounge
    const chaise = new THREE.Mesh(new THREE.BoxGeometry(1.3,.55,1.9), sofaFabric); 
    chaise.position.set(9.2,.27,1.6); 
    chaise.castShadow=true; 
    scene.add(chaise);
    addBoxCollider(9.2,0.55,1.6,1.3,1.9);

    // Coffee table
    const ct = new THREE.Mesh(
      new THREE.BoxGeometry(1.7,.2,.95), 
      new THREE.MeshStandardMaterial({ 
        color:0xa67c52, 
        roughness:.45, 
        metalness:.3 
      })
    ); 
    ct.position.set(7.4,0.62,0.8); 
    ct.castShadow=true; 
    scene.add(ct);
    addBoxCollider(7.4,0.62,0.8,1.7,0.95);

    // TV entertainment center
    const tvGroup = new THREE.Group();
    tvGroup.position.set(7.5,0,-1.4);

    // TV stand with drawers
    const standBase = new THREE.Mesh(
      new THREE.BoxGeometry(3.2,.35,.7), 
      new THREE.MeshStandardMaterial({ 
        color:0x5a3d2b, 
        roughness:.55, 
        metalness:.2 
      })
    );
    standBase.position.set(0,1.0,0.2); 
    standBase.castShadow=true; 
    tvGroup.add(standBase);

    // Drawer handles
    [-0.8,0,0.8].forEach(x=>{
      const handle = new THREE.Mesh(
        new THREE.CylinderGeometry(.03,.03,.2,12),
        new THREE.MeshStandardMaterial({ color:0xc0c0c0, metalness:.8, roughness:.3 })
      );
      handle.rotation.z = Math.PI/2;
      handle.position.set(x, 1.0, 0.55);
      tvGroup.add(handle);
    });
    
    addBoxCollider(7.5,1.0,-1.4,3.2,0.7);

    // Modern TV screen
    const tvMat = new THREE.MeshStandardMaterial({ 
      color:0x0a0a0a, 
      emissive:0x2a7fff, 
      emissiveIntensity:0.0,
      roughness:.2,
      metalness:.8
    });
    const tvScreen = new THREE.Mesh(new THREE.PlaneGeometry(2.6,1.5), tvMat);
    tvScreen.position.set(0,2.1,0.05); 
    tvScreen.userData.interactable = 'tv';
    tvGroup.add(tvScreen);
    tvRef = tvScreen;

    // TV frame
    const tvFrame = new THREE.Mesh(
      new THREE.BoxGeometry(2.8,1.7,.08),
      new THREE.MeshStandardMaterial({ color:0x1a1a1a, roughness:.4, metalness:.6 })
    );
    tvFrame.position.set(0,2.1,0);
    tvGroup.add(tvFrame);

    tvGroup.userData.interactable = 'tv';
    interactiveMeshes.push(tvScreen, tvGroup);
    scene.add(tvGroup);
  }

  function buildCloset(){
    // Beautiful wooden closet next to TV
    const closetWood = new THREE.MeshStandardMaterial({ 
      color:0x8b5a3c, 
      roughness:.65, 
      metalness:.15 
    });
    
    const body = new THREE.Mesh(new THREE.BoxGeometry(1.9,3.4,1.1), closetWood);
    body.position.set(10.6, 1.7, -1.4); 
    body.castShadow=true; 
    body.receiveShadow=true; 
    scene.add(body);

    // Two elegant wooden doors
    const doorMat = new THREE.MeshStandardMaterial({ 
      color:0xa67043, 
      roughness:.6, 
      metalness:.12 
    });
    
    const doorL = new THREE.Mesh(new THREE.BoxGeometry(.88, 3.1, .08), doorMat); 
    doorL.position.set(10.16, 1.7, -.87); 
    doorL.castShadow=true; 
    scene.add(doorL);
    
    const doorR = new THREE.Mesh(new THREE.BoxGeometry(.88, 3.1, .08), doorMat); 
    doorR.position.set(11.04, 1.7, -.87); 
    doorR.castShadow=true; 
    scene.add(doorR);

    // Door panels (decorative)
    [doorL, doorR].forEach(door=>{
      const panel = new THREE.Mesh(
        new THREE.BoxGeometry(.7, 2.5, .04),
        new THREE.MeshStandardMaterial({ color:0x9a6238, roughness:.7 })
      );
      panel.position.copy(door.position);
      panel.position.z -= .05;
      scene.add(panel);
    });

    // Elegant handles
    const handleMat = new THREE.MeshStandardMaterial({ 
      color:0x3d2817, 
      metalness:.5, 
      roughness:.4 
    });
    
    const handleL = new THREE.Mesh(new THREE.CylinderGeometry(.035,.035,.2, 16), handleMat); 
    handleL.rotation.z = Math.PI/2; 
    handleL.position.set(10.48,1.7,-.82); 
    handleL.castShadow=true; 
    scene.add(handleL);
    
    const handleR = handleL.clone(); 
    handleR.position.set(10.72,1.7,-.82); 
    handleR.castShadow=true; 
    scene.add(handleR);

    addBoxCollider(10.6, 3.4, -1.4, 1.9, 1.1);
  }

  function buildCake(){
    const g = new THREE.Group();
    
    // Three beautiful cake layers
    const layers=[
      {r:1.1,h:.65,y:.32,c:0xffb6c1,d:0xff91b5},
      {r:.88,h:.55,y:.95,c:0xffffff,d:0xffd9e6},
      {r:.68,h:.45,y:1.45,c:0xffb6c1,d:0xff91b5}
    ];
    
    layers.forEach((L,idx)=>{
      // Main layer
      const layer=new THREE.Mesh(
        new THREE.CylinderGeometry(L.r,L.r,L.h,32), 
        new THREE.MeshStandardMaterial({ 
          color:L.c, 
          roughness:.5,
          metalness:.1
        })
      ); 
      layer.position.y=L.y; 
      layer.castShadow=true; 
      g.add(layer);

      // Frosting drips
      for(let i=0;i<20;i++){ 
        const a=(i/20)*Math.PI*2; 
        const drip=new THREE.Mesh(
          new THREE.SphereGeometry(.08,8,8), 
          new THREE.MeshStandardMaterial({ color:L.d, roughness:.4 })
        ); 
        drip.position.set(
          Math.cos(a)*(L.r-.04), 
          L.y-L.h/2-.06, 
          Math.sin(a)*(L.r-.04)
        ); 
        drip.scale.y = 1.4;
        drip.castShadow=true; 
        g.add(drip); 
      }

      // Decorative flowers on top layer
      if(idx === 2){
        for(let i=0;i<8;i++){
          const a=(i/8)*Math.PI*2;
          const flower=new THREE.Mesh(
            new THREE.SphereGeometry(.06,8,8),
            new THREE.MeshStandardMaterial({ 
              color:0xffd700,
              emissive:0xffaa00,
              emissiveIntensity:.3
            })
          );
          flower.position.set(
            Math.cos(a)*(L.r-.15),
            L.y+L.h/2+.03,
            Math.sin(a)*(L.r-.15)
          );
          flower.castShadow=true;
          g.add(flower);
        }
      }
    });
    
    // Beautiful candles
    [-.3,.3].forEach(x=>{
      // Candle body
      const candle=new THREE.Mesh(
        new THREE.CylinderGeometry(.06,.06,.65,16), 
        new THREE.MeshStandardMaterial({ 
          color:0xffd700,
          roughness:.3,
          metalness:.4
        })
      ); 
      candle.position.set(x,1.72,0); 
      candle.castShadow=true; 
      g.add(candle);

      // Candle flame
      const flame=new THREE.Mesh(
        new THREE.SphereGeometry(.10,8,8), 
        new THREE.MeshBasicMaterial({ 
          color:0xffa500, 
          transparent:true, 
          opacity:.95 
        })
      ); 
      flame.position.set(x,2.02,0); 
      flame.scale.y=1.3; 
      flame.userData.baseY=2.02; 
      g.add(flame);

      // Flame glow
      const glow=new THREE.PointLight(0xffa500,2.0,5); 
      glow.position.copy(flame.position); 
      g.add(glow);
      
      candles.push({flame,glow});
    });
    
    g.position.set(0,1.42,-.8);
    g.userData.interactable='cake';
    scene.add(g);
    interactiveMeshes.push(g);
    cakeGroup = g;
  }

  function buildBanner(){
    // Beautiful birthday banner
    const cnv=document.createElement('canvas'); 
    cnv.width=2048; 
    cnv.height=320; 
    const ctx=cnv.getContext('2d');
    
    // Gradient background
    const grad=ctx.createLinearGradient(0,0,cnv.width,0); 
    grad.addColorStop(0,'#ff6b9d'); 
    grad.addColorStop(.25,'#c44569'); 
    grad.addColorStop(.5,'#f8b500'); 
    grad.addColorStop(.75,'#6a5acd'); 
    grad.addColorStop(1,'#ff6b9d');
    ctx.fillStyle=grad; 
    ctx.fillRect(0,0,cnv.width,cnv.height);
    
    // Text with shadow
    ctx.shadowColor = 'rgba(0,0,0,0.5)';
    ctx.shadowBlur = 20;
    ctx.shadowOffsetX = 4;
    ctx.shadowOffsetY = 4;
    ctx.lineWidth=12; 
    ctx.strokeStyle='#1a0b2e'; 
    ctx.font='bold 160px Arial'; 
    ctx.textAlign='center';
    ctx.strokeText('üéâ HAPPY BIRTHDAY! üéâ',1024,210); 
    
    ctx.shadowColor = 'transparent';
    ctx.fillStyle='#fff'; 
    ctx.fillText('üéâ HAPPY BIRTHDAY! üéâ',1024,210);
    
    const banner=new THREE.Mesh(
      new THREE.PlaneGeometry(10.5,1.3), 
      new THREE.MeshBasicMaterial({ 
        map:new THREE.CanvasTexture(cnv), 
        transparent:true 
      })
    ); 
    banner.position.set(0,8.5,-12.28); 
    scene.add(banner);
  }

  function buildPhotoFrame(){
    const PHOTO_URL = './a.jpg';
    const loader=new THREE.TextureLoader();
    loader.crossOrigin = 'anonymous'; // Added for CORS compatibility
    
    // Ornate picture frame
    const outerFrame=new THREE.Mesh(
      new THREE.BoxGeometry(5.5,4.0,.2), 
      new THREE.MeshStandardMaterial({ 
        color:0x8b6914, 
        roughness:.5, 
        metalness:.4 
      })
    );
    outerFrame.position.set(0,2.5,-12.42);
    outerFrame.castShadow=true; 
    scene.add(outerFrame);
    
    const innerFrame=new THREE.Mesh(
      new THREE.BoxGeometry(5.3,3.8,.15), 
      new THREE.MeshStandardMaterial({ 
        color:0xdaa520, 
        roughness:.4, 
        metalness:.6 
      })
    );
    innerFrame.position.set(0,2.5,-12.36);
    scene.add(innerFrame);
    
    // Load photo with error handling
    loader.load(
    PHOTO_URL,
    (tex)=>{
      const pic=new THREE.Mesh(
        new THREE.PlaneGeometry(5.0,3.5), 
        new THREE.MeshStandardMaterial({ 
          map:tex, 
          roughness:.75 
        })
      );
      pic.position.set(0,2.5,-12.31); 
      pic.receiveShadow=true; 
      scene.add(pic);
      pic.userData.interactable='photo';
      interactiveMeshes.push(pic);
      console.log('Photo loaded successfully!');
    },
    (progress)=>{
      console.log('Loading photo:', Math.round((progress.loaded/progress.total)*100) + '%');
    },
    (err)=>{ 
      console.error('Failed to load photo:', err); 
      console.error('Make sure "a.jpg" exists in the same directory as index.html');
      // Create a placeholder with a nice gradient if image fails to load
      const placeholder=new THREE.Mesh(
        new THREE.PlaneGeometry(5.0,3.5), 
        new THREE.MeshStandardMaterial({ 
          color:0xff91b5,
          emissive:0xff69b4,
          emissiveIntensity:0.2,
          roughness:.75 
        })
      );
      placeholder.position.set(0,2.5,-12.31);
      placeholder.receiveShadow=true; 
      scene.add(placeholder);
      placeholder.userData.interactable='photo';
      interactiveMeshes.push(placeholder);
    }
  );
    
    // Picture lights
    const s1=new THREE.SpotLight(0xfff5e6,1.8,16,Math.PI/6.5,.5); 
    s1.position.set(-2.5,8.5,-10); 
    s1.target.position.set(0,2.5,-12.3);
    s1.castShadow = true;
    s1.userData.intensity = 1.8;
    scene.add(s1); 
    scene.add(s1.target); 
    roomLights.push(s1);
    
    const s2=new THREE.SpotLight(0xfff5e6,1.8,16,Math.PI/6.5,.5); 
    s2.position.set(2.5,8.5,-10);  
    s2.target.position.set(0,2.5,-12.3);
    s2.castShadow = true;
    s2.userData.intensity = 1.8;
    scene.add(s2); 
    scene.add(s2.target); 
    roomLights.push(s2);
  }

  function buildStringLights(){
    const y=7.8, z=-12.15;
    const xs=[-9,-7,-5,-3,-1,1,3,5,7,9];
    const bulbGeo=new THREE.SphereGeometry(0.10,12,12);

    xs.forEach((x,i)=>{
      const colors=[0xffeb3b,0xff9800,0xff5722,0xe91e63,0x9c27b0,0x3f51b5];
      const bulbColor = colors[i % colors.length];
      
      const bulbMat=new THREE.MeshStandardMaterial({ 
        color:bulbColor,
        emissive:bulbColor,
        emissiveIntensity:.6,
        roughness:.3,
        metalness:.2
      });
      
      const bulb=new THREE.Mesh(bulbGeo,bulbMat); 
      bulb.position.set(x, y+Math.sin(i*0.7)*0.45, z); 
      bulb.castShadow = true;
      scene.add(bulb);
      
      const p=new THREE.PointLight(bulbColor, 0.5, 4.0);
      p.position.copy(bulb.position); 
      p.userData.intensity = 0.5;
      scene.add(p);
      fairyLights.push(p);
      roomLights.push(p);
    });

    // String wire
    for(let i=0;i<xs.length-1;i++){
      const midX=(xs[i]+xs[i+1])/2;
      const seg=new THREE.Mesh(
        new THREE.CylinderGeometry(.015,.015,Math.abs(xs[i+1]-xs[i]),8),
        new THREE.MeshStandardMaterial({ color:0x2c2c2c, roughness:.8 })
      );
      seg.rotation.z = Math.PI/2;
      seg.position.set(midX, y+Math.sin((i+0.5)*0.7)*0.45, z);
      scene.add(seg);
    }
  }

  function addDecorations(){
    // Balloons floating
    const balloonPositions = [
      {x:-8, y:6.5, z:-6, c:0xff69b4},
      {x:-9, y:7.2, z:-4, c:0x6a6cff},
      {x:8, y:6.8, z:-6, c:0xffd36a},
      {x:9.5, y:7.5, z:-5, c:0xff5f9e},
      {x:-6, y:6.2, z:8, c:0x9b5eff}
    ];

    balloonPositions.forEach((bp,idx)=>{
      const balloon = new THREE.Group();
      
      // Balloon body
      const body = new THREE.Mesh(
        new THREE.SphereGeometry(.4,16,16),
        new THREE.MeshStandardMaterial({
          color:bp.c,
          roughness:.6,
          metalness:.1,
          emissive:bp.c,
          emissiveIntensity:.2
        })
      );
      body.scale.y = 1.3;
      body.castShadow = true;
      balloon.add(body);

      // Balloon knot
      const knot = new THREE.Mesh(
        new THREE.SphereGeometry(.08,8,8),
        new THREE.MeshStandardMaterial({color:bp.c, roughness:.7})
      );
      knot.position.y = -.55;
      knot.scale.y = 1.5;
      balloon.add(knot);

      // String
      const string = new THREE.Mesh(
        new THREE.CylinderGeometry(.01,.01,2,8),
        new THREE.MeshStandardMaterial({color:0xffffff, roughness:.9})
      );
      string.position.y = -1.55;
      balloon.add(string);

      balloon.position.set(bp.x, bp.y, bp.z);
      balloon.userData.baseY = bp.y;
      balloon.userData.floatOffset = idx * Math.PI * 0.5;
      balloon.userData.floatSpeed = 0.8 + Math.random() * 0.4;
      scene.add(balloon);
      balloons.push(balloon);
    });

    // Floor decorations - rose petals
    for(let i=0;i<40;i++){
      const petal = new THREE.Mesh(
        new THREE.CircleGeometry(.08,6),
        new THREE.MeshStandardMaterial({
          color: i%3 ? 0xff91b5 : 0xffb6d9,
          roughness:.9,
          side: THREE.DoubleSide
        })
      );
      petal.rotation.x = -Math.PI/2;
      petal.rotation.z = Math.random() * Math.PI * 2;
      petal.position.set(
        (Math.random()-.5)*10,
        .025,
        (Math.random()-.5)*10
      );
      petal.receiveShadow = true;
      scene.add(petal);
    }
  }

  // ====== UI / INPUT ======
  function initUI(){
    document.getElementById('musicBtn').onclick = toggleMusic;
    document.getElementById('resetBtn').onclick = resetPosition;

    const cm = document.getElementById('controlsMobile');
    const hd = document.getElementById('helpDesktop');
    const toast = document.getElementById('toast');
    if(isDesktop){ 
      cm.classList.remove('active'); 
      toast.innerText = "";
      initDesktopControls(); 
    } else { 
      cm.classList.add('active'); 
      hd.style.display = 'none';
      toast.style.display = 'none';
      initMobileControls(); 
    }

    const modal=document.getElementById('wishModal');
    modal.addEventListener('click',(e)=>{ 
      if(e.target.hasAttribute('data-close')) closeModal(); 
    });
    document.getElementById('btnPlayVoice').addEventListener('click', playVoiceMessage);

    document.getElementById('btnJump').addEventListener('touchstart',(e)=>{ e.preventDefault(); doJump(); });
    document.getElementById('btnInteract').addEventListener('touchstart',(e)=>{ e.preventDefault(); interact(); });
    document.getElementById('btnBlow').addEventListener('touchstart',(e)=>{ e.preventDefault(); blowCandles(); });
    document.getElementById('btnLights').addEventListener('touchstart',(e)=>{ e.preventDefault(); toggleLights(); });
  }

  function initDesktopControls(){
    document.body.addEventListener('click', ()=>{ 
      if(document.activeElement!==canvas) canvas.focus({preventScroll:true}); 
    }, true);
    
    canvas.addEventListener('click', ()=>{ 
      canvas.requestPointerLock(); 
    });
    
    document.addEventListener('pointerlockchange', ()=>{ 
      const tip=document.getElementById('lockTip'); 
      if(document.pointerLockElement===canvas){ 
        tip.classList.remove('active'); 
      } else { 
        tip.classList.add('active'); 
      } 
    });

    document.addEventListener('mousemove', onMouseMove);

    document.addEventListener('keydown', (e)=>{
      const code=e.code;
      if(['KeyW','KeyA','KeyS','KeyD','ArrowUp','ArrowLeft','ArrowDown','ArrowRight','Space'].includes(code)) e.preventDefault();
      switch(code){
        case 'KeyW': case 'ArrowUp': moves.forward = true; break;
        case 'KeyS': case 'ArrowDown': moves.backward = true; break;
        case 'KeyA': case 'ArrowLeft': moves.left = true; break;
        case 'KeyD': case 'ArrowRight': moves.right = true; break;
        case 'Space': doJump(); break;
        case 'KeyE': interact(); break;
        case 'KeyL': toggleLights(); break;
        case 'KeyB': blowCandles(); break;
      }
    });
    
    document.addEventListener('keyup', (e)=>{
      const code=e.code;
      if(['KeyW','KeyA','KeyS','KeyD','ArrowUp','ArrowLeft','ArrowDown','ArrowRight','Space'].includes(code)) e.preventDefault();
      switch(code){
        case 'KeyW': case 'ArrowUp': moves.forward = false; break;
        case 'KeyS': case 'ArrowDown': moves.backward = false; break;
        case 'KeyA': case 'ArrowLeft': moves.left = false; break;
        case 'KeyD': case 'ArrowRight': moves.right = false; break;
      }
    });
  }

  function onMouseMove(e) {
    if (document.pointerLockElement !== canvas) return;
    euler.setFromQuaternion(camera.quaternion);
    euler.y -= e.movementX * 0.002;
    euler.x -= e.movementY * 0.002;
    euler.x = Math.max(-PI_2, Math.min(PI_2, euler.x));
    camera.quaternion.setFromEuler(euler);
  }

  function initMobileControls(){
    const joy = document.getElementById('joy');
    const joyStick = document.getElementById('joyStick');
    const controlsMobile = document.getElementById('controlsMobile');

    joy.addEventListener('touchstart', (e) => {
      e.preventDefault();
      joyActive = true;
    });

    joy.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = joy.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      let dx = touch.clientX - centerX;
      let dy = touch.clientY - centerY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      const maxR = rect.width / 2 - 30;
      if (dist > maxR) {
        dx = dx / dist * maxR;
        dy = dy / dist * maxR;
      }
      joyStick.style.transform = `translate(${dx}px, ${dy}px)`;
      joyVec.x = dx / maxR;
      joyVec.y = dy / maxR;
    });

    joy.addEventListener('touchend', (e) => {
      e.preventDefault();
      joyActive = false;
      joyStick.style.transform = 'translate(0,0)';
      joyVec = {x:0, y:0};
    });

    // Look controls - touch anywhere on canvas
    canvas.addEventListener('touchstart', (e) => {
      // Only capture first touch for looking
      if (lookTouchId === null && e.touches.length > 0) {
        const touch = e.touches[0];
        
        // Check if touch is on control area at bottom
        const rect = controlsMobile.getBoundingClientRect();
        const isOnControls = (
          touch.clientY >= rect.top &&
          touch.clientX >= rect.left && 
          touch.clientX <= rect.right
        );
        
        if (!isOnControls) {
          e.preventDefault();
          lookTouchId = touch.identifier;
          lastTouchX = touch.clientX;
          lastTouchY = touch.clientY;
        }
      }
    }, {passive: false});

    canvas.addEventListener('touchmove', (e) => {
      for (let touch of e.touches) {
        if (touch.identifier === lookTouchId) {
          e.preventDefault();
          const dx = touch.clientX - lastTouchX;
          const dy = touch.clientY - lastTouchY;
          
          euler.setFromQuaternion(camera.quaternion);
          euler.y -= dx * 0.005;  // Increased sensitivity
          euler.x -= dy * 0.005;  // Increased sensitivity
          euler.x = Math.max(-PI_2 + 0.01, Math.min(PI_2 - 0.01, euler.x));
          camera.quaternion.setFromEuler(euler);
          
          lastTouchX = touch.clientX;
          lastTouchY = touch.clientY;
          break;
        }
      }
    }, {passive: false});

    canvas.addEventListener('touchend', (e) => {
      for (let touch of e.changedTouches) {
        if (touch.identifier === lookTouchId) {
          lookTouchId = null;
          break;
        }
      }
    });

    canvas.addEventListener('touchcancel', (e) => {
      for (let touch of e.changedTouches) {
        if (touch.identifier === lookTouchId) {
          lookTouchId = null;
          break;
        }
      }
    });
  }

  function getFloorHeightAt(x, z) {
    let maxFloor = 0;
    for (let col of colliders) {
      if (x > col.minX && x < col.maxX && z > col.minZ && z < col.maxZ) {
        maxFloor = Math.max(maxFloor, col.topY);
      }
    }
    return maxFloor;
  }

  function checkCollision(nextPos) {
    const px = nextPos.x;
    const pz = nextPos.z;
    const py = nextPos.y;
    const margin = 0.5;
    for (let col of colliders) {
      if (
        px > col.minX - margin && 
        px < col.maxX + margin && 
        pz > col.minZ - margin && 
        pz < col.maxZ + margin && 
        py < col.topY + EYE_HEIGHT
      ) {
        return true;
      }
    }
    return false;
  }

  function doJump() {
    if (canJump) {
      velocity.y += 8;
      canJump = false;
    }
  }

  function interact() {
    const raycaster = new THREE.Raycaster();
    raycaster.setFromCamera(new THREE.Vector2(0, 0), camera);
    const intersects = raycaster.intersectObjects(interactiveMeshes);
    if (intersects.length > 0 && intersects[0].distance < INTERACT_RAY_MAX) {
      const obj = intersects[0].object;
      const type = obj.userData.interactable;
      if (type === 'tv') {
        tvRef.material.emissiveIntensity = tvRef.material.emissiveIntensity > 0 ? 0 : 0.8;
      } else if (type === 'photo') {
        document.getElementById('wishModal').classList.add('active');
      }
    }
  }

  function blowCandles() {
    if (candlesLit) {
      candles.forEach(c => {
        c.flame.visible = false;
        c.glow.intensity = 0;
      });
      candlesLit = false;
      document.getElementById('wishModal').classList.add('active');
    }
  }

  function toggleLights() {
    lightsOn = !lightsOn;
    roomLights.forEach(l => l.intensity = lightsOn ? l.userData.intensity : 0);
    windowMeshes.forEach(w => w.material.emissiveIntensity = lightsOn ? 0.8 : 0);
    if (!lightsOn && !candlesLit) {
      candles.forEach(c => {
        c.flame.visible = true;
        c.glow.intensity = 2.0;
      });
      candlesLit = true;
    }
  }

  function closeModal() {
    document.getElementById('wishModal').classList.remove('active');
  }

  function playVoiceMessage() {
    const voicePlayer = document.getElementById('voicePlayer');
    
    // Stop birthday music when voice plays - music won't resume automatically
    if (musicOn) {
      musicOn = false;
    }
    
    voicePlayer.src = './b.mp3';
    voicePlayer.load();
    voicePlayer.play().catch(err => console.error('Audio playback failed:', err));
  }

  function resetPosition() {
    camera.position.set(0, EYE_HEIGHT, 8);
    camera.quaternion.set(0, 0, 0, 1);
    velocity.set(0, 0, 0);
  }

  function startMusic() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    musicOn = true;
    playNote(0);
  }

  function playNote(seq) {
    if (!musicOn || seq >= notes.length) {
      if (musicOn) setTimeout(() => playNote(0), 1000);
      return;
    }
    const note = notes[seq];
    const osc = audioCtx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = note.freq;
    const gain = audioCtx.createGain();
    gain.gain.value = 0.2;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    setTimeout(() => {
      osc.stop();
      playNote(seq + 1);
    }, note.dur * 1000);
  }

  function toggleMusic() {
    musicOn = !musicOn;
    if (musicOn) playNote(0);
  }

  function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  function animate() {
    requestAnimationFrame(animate);
    const delta = Math.min(clock.getDelta(), 0.033);
    const time = clock.elapsedTime;

    // Update movement
    direction.set(0, 0, 0);
    if (moves.forward) direction.z -= 1;
    if (moves.backward) direction.z += 1;
    if (moves.left) direction.x -= 1;
    if (moves.right) direction.x += 1;
    direction.normalize();

    const speed = 5;
    if (direction.length() > 0) {
      const forward = new THREE.Vector3();
      camera.getWorldDirection(forward);
      forward.y = 0;
      forward.normalize();
      const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0, 1, 0));
      const moveDir = new THREE.Vector3()
        .addScaledVector(forward, -direction.z)
        .addScaledVector(right, direction.x)
        .normalize();
      velocity.x = moveDir.x * speed;
      velocity.z = moveDir.z * speed;
    } else if (!joyActive) {
      velocity.x *= 0.8;
      velocity.z *= 0.8;
    }

    if (!isDesktop && joyActive) {
      const strength = Math.sqrt(joyVec.x ** 2 + joyVec.y ** 2);
      if (strength > 0.1) {
        const forward = new THREE.Vector3();
        camera.getWorldDirection(forward);
        forward.y = 0;
        forward.normalize();
        const right = new THREE.Vector3().crossVectors(forward, new THREE.Vector3(0, 1, 0));
        const moveDir = new THREE.Vector3()
          .addScaledVector(right, joyVec.x)
          .addScaledVector(forward, -joyVec.y)
          .normalize();
        velocity.x = moveDir.x * speed * strength;
        velocity.z = moveDir.z * speed * strength;
      } else {
        velocity.x *= 0.8;
        velocity.z *= 0.8;
      }
    }

    // Horizontal movement
    const horizVel = new THREE.Vector3(velocity.x, 0, velocity.z);
    const nextHorizPos = camera.position.clone().addScaledVector(horizVel, delta);

    if (!checkCollision(nextHorizPos)) {
      camera.position.x = nextHorizPos.x;
      camera.position.z = nextHorizPos.z;
    } else {
      // Try sliding along axes
      const tryX = camera.position.clone().addScaledVector(new THREE.Vector3(velocity.x, 0, 0), delta);
      const tryZ = camera.position.clone().addScaledVector(new THREE.Vector3(0, 0, velocity.z), delta);
      if (!checkCollision(tryX)) {
        camera.position.x = tryX.x;
        velocity.z *= 0.5;
      }
      if (!checkCollision(tryZ)) {
        camera.position.z = tryZ.z;
        velocity.x *= 0.5;
      }
    }

    camera.position.x = Math.max(-ROOM_BOUND, Math.min(ROOM_BOUND, camera.position.x));
    camera.position.z = Math.max(-ROOM_BOUND, Math.min(ROOM_BOUND, camera.position.z));

    // Vertical movement (gravity and jumping)
    velocity.y -= 20 * delta; // Gravity
    const nextPos = camera.position.clone().addScaledVector(velocity, delta);
    const floorHeight = getFloorHeightAt(nextPos.x, nextPos.z);

    if (nextPos.y < floorHeight + EYE_HEIGHT) {
      nextPos.y = floorHeight + EYE_HEIGHT;
      velocity.y = 0;
      canJump = true;
    }

    if (!checkCollision(nextPos)) {
      camera.position.y = nextPos.y;
    } else {
      velocity.y = 0;
      canJump = true;
    }

    // Update balloons
    balloons.forEach(balloon => {
      const t = time * balloon.userData.floatSpeed;
      balloon.position.y = balloon.userData.baseY + Math.sin(t + balloon.userData.floatOffset) * 0.2;
    });

    // Update candle flames
    if (candlesLit) {
      candles.forEach(c => {
        c.flame.position.y = c.flame.userData.baseY + Math.sin(time * 4) * 0.02;
        c.flame.scale.setScalar(0.9 + Math.sin(time * 5) * 0.1);
        c.glow.position.copy(c.flame.position);
      });
    }

    renderer.render(scene, camera);
  }

  </script>
</body>

</html>
